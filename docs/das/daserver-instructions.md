## Data Availability Server Instructions
#### Image:
`offchainlabs/TODO IMAGE NAME AND VERSION`
#### Usage of daserver:
      --conf.dump                                          print out currently active configuration file
      --conf.env-prefix string                             environment variables with given prefix will be loaded as configuration values
      --conf.file strings                                  name of configuration file
      --conf.s3.access-key string                          S3 access key
      --conf.s3.bucket string                              S3 bucket
      --conf.s3.object-key string                          S3 object key
      --conf.s3.region string                              S3 region
      --conf.s3.secret-key string                          S3 secret key
      --conf.string string                                 configuration as JSON string
      --data-availability.aggregator.assumed-honest int    Number of assumed honest backends (H). If there are N backends, K=N+1-H valid responses are required to consider an Store request to be successful.
      --data-availability.aggregator.backends string       JSON RPC backend configuration
      --data-availability.local-disk.allow-generate-keys   Allow the local disk DAS to generate its own keys in key-dir if they don't already exist
      --data-availability.local-disk.data-dir string       The directory to use as the DAS file-based database
      --data-availability.local-disk.key-dir string        The directory to read the bls keypair ('das_bls.pub' and 'das_bls') from
      --data-availability.local-disk.priv-key string       The base64 BLS private key to use for signing DAS certificates
      --data-availability.mode string                      mode ('onchain', 'local-disk', or 'aggregator') (default "onchain")
      --log-level int                                      log level (default 3)
      --port uint                                          Port to listen on (default 9876)


## Sample Deployment

### Local Disk Mode

The Data Availability Service (DAS) in local disk mode requires:
- a BLS private key to sign the Data Availability Certificates it returns to clients (the batch poster) requesting to Store data
- the ethereum address of the batch poster to verify that it made the Store requests
- a persistent volume to write the stored data to 

The BLS keypair for can be generated using the `datool keygen` utility or by having `daserver` generate it on startup if it could not be found (examples for both given below). If the keys is pre-generated it can be passed to the `dasever` executable by file or on the command line.

Once the DAS is set up, the local public key `das_bls.pub` and should be communicated out-of-band to the operator of the Data Availability Service Aggregator, along with a host and port that the aggregator can reach, so that it can be added to the committee keyset.

TODO put a sample k8s Deployment yaml here
- Peristent volume for locally stored data
- Secret volume for private key

#### Running when generating keys automatically
The daserver in local disk mode can be run in a mode where it will generate a new BLS private key if one does not exist.

```
/usr/local/bin/daserver --data-availability.mode local-disk --data-availability.local-disk.allow-generate-keys --data-availability.local-disk.key-dir <TODO PERSISTENT VOLUME> --data-availability.local-disk.data-dir <TODO SECRET VOLUME>
--OPTION-NAME-TODO <SEQUENCER ADDRESS>
```

#### Running when pregenerating the BLS keys

```
/usr/local/bin/datool keygen --dir /local/dir/of/your/choice
```
Copy the `das_bls` and `das_bls.pub` files to the <TODO SECRET VOLUME>

```
/usr/local/bin/daserver --data-availability.mode local-disk --data-availability.local-disk.key-dir <TODO PERSISTENT VOLUME> --data-availability.local-disk.data-dir <TODO SECRET VOLUME>
--OPTION-NAME-TODO <SEQUENCER ADDRESS>
```

Alternatively the private key can be passed in via the command line:
```
/usr/local/bin/daserver --data-availability.mode local-disk --data-availability.local-disk.priv-key "CONTENTS OF das_bls PRIVATE KEY FILE" --data-availability.local-disk.data-dir <TODO SECRET VOLUME>
--OPTION-NAME-TODO <SEQUENCER ADDRESS>
```

#### Passing in config by file
Configuration can be passed in via the command line or via a JSON config file. Depending on your site setup it may be preferable to use a JSON configuration file. The JSON config for any `daserver` command line invocation can be generated by appending the `--conf.dump` flag and then once saved, `--conf.file` can be used to select the file.

## Validating deployment
In the docker image there is the `datool` utility that can be used to Store and Retrieve messages from a DAS. In order for the DAS to accept the Store requests, --OPTION-NAME-TODO must be ommitted when running `daserver` since you will not have the batch poster's private key to sign the messages with. --OPTION-NAME-TODO should be renabled when done verifying and before allowing external traffic.

```
$ /usr/local/bin/datool client store --url localhost:9876 --message "Hello world"
Base64 Encoded Cert: gIQusW9kVVDt3bIIi6jo+RlFSqVd/40z/aSADWJvOV9H7WwRsLW4CJYN8m9b/EcdBMGZWw/9IFWSWtG+KNa6rf0AAAAAYn1lrwAAAAAAAAABCgVCGJWsseHBNRgaOVBeNj4eH3kZhZGIfxjCr8Uf22FtS3+8f839VxX5OASahFqODMP/JgiHQARAQPVsbllvWjJz8ZJ13a0Y094O2VKjyRog7qNM3VwyPkkvfhycmfNN
$ ./target/bin/datool client retrieve --url localhost:9876 --cert "gIQusW9kVVDt3bIIi6jo+RlFSqVd/40z/aSADWJvOV9H7WwRsLW4CJYN8m9b/EcdBMGZWw/9IFWSWtG+KNa6rf0AAAAAYn1lrwAAAAAAAAABCgVCGJWsseHBNRgaOVBeNj4eH3kZhZGIfxjCr8Uf22FtS3+8f839VxX5OASahFqODMP/JgiHQARAQPVsbllvWjJz8ZJ13a0Y094O2VKjyRog7qNM3VwyPkkvfhycmfNN"
Message: Hello world
```